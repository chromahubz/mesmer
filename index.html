<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesmer - Generative Audiovisual Engine</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Dual-layer canvas system -->
        <canvas id="mainCanvas"></canvas>
        <canvas id="toyCanvas"></canvas>

        <!-- Debug Overlay -->
        <div id="debugOverlay" style="position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.9); color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; z-index: 1000; max-width: 300px; border: 2px solid #0f0;">
            <div style="font-weight: bold; margin-bottom: 10px; color: #ff0;">MESMER DEBUG</div>
            <div id="debugContent">Initializing...</div>
            <button onclick="document.getElementById('debugOverlay').style.display='none'" style="margin-top: 10px; padding: 5px 10px; background: #f00; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">Hide</button>
        </div>

        <!-- Shader Editor Panel (Left Side) -->
        <div class="shader-editor-left collapsed" id="shaderEditorLeft">
            <div class="editor-header">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                    </svg>
                    Shader Editor
                </h3>
                <button id="toggleEditorLeft" class="btn-icon">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </button>
            </div>

            <div class="editor-content" id="editorContentLeft">
                <div class="editor-toolbar">
                    <div class="format-toggle">
                        <button id="formatGLSL" class="format-btn active">GLSL</button>
                        <button id="formatShaderToy" class="format-btn">ShaderToy</button>
                    </div>
                    <div class="target-layer">
                        <label>Target:</label>
                        <select id="targetLayer">
                            <option value="main">Main Layer</option>
                            <option value="toy">ShaderToy Layer</option>
                        </select>
                    </div>
                </div>

                <div class="editor-helper">
                    <span class="helper-text">Paste GLSL or ShaderToy code below</span>
                    <div class="helper-buttons">
                        <button id="copyCodeBtn" class="btn-mini" title="Copy code">
                            <svg class="icon-mini" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                        <button id="pasteCodeBtn" class="btn-mini" title="Paste from clipboard">
                            <svg class="icon-mini" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="editor-textarea-wrapper">
                    <textarea id="shaderCode" class="shader-code" spellcheck="false" placeholder="// Paste your shader code here..."></textarea>
                    <div class="editor-line-numbers" id="lineNumbers"></div>
                </div>

                <div class="editor-controls">
                    <button id="compileBtn" class="btn-primary">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        Compile & Run
                    </button>
                    <button id="loadPresetBtn" class="btn-secondary">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        Presets
                    </button>
                    <button id="clearBtn" class="btn-secondary">Clear</button>
                </div>

                <div class="editor-status" id="editorStatus">
                    <span class="status-text">Ready</span>
                </div>

                <!-- Preset Library Modal -->
                <div class="preset-modal" id="presetModal" style="display: none;">
                    <div class="preset-modal-content">
                        <div class="preset-modal-header">
                            <h3>Shader Presets</h3>
                            <button id="closePresetModal" class="btn-icon">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="preset-grid" id="presetGrid">
                            <!-- Presets will be dynamically loaded -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drum Sequencer Panel -->
        <div class="drum-sequencer" id="drumSequencer" style="display: none;">
            <div class="sequencer-header" id="sequencerHeader">
                <h3>ü•Å DRUM SEQUENCER</h3>
                <div style="display: flex; gap: 10px;">
                    <button id="toggleSequencerBtn" class="btn-icon" title="Collapse/Expand">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                        </svg>
                    </button>
                    <button id="closeDrumSequencer" class="btn-icon">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="sequencer-controls">
                <div class="drum-channel" data-drum="kick">
                    <div class="channel-header">
                        <span class="channel-name">KICK</span>
                        <input type="range" class="drum-volume" min="0" max="100" value="100" data-channel="kick">
                        <span class="volume-value">100</span>
                    </div>
                    <div class="step-grid">
                        <!-- 16 steps will be created dynamically -->
                    </div>
                </div>

                <div class="drum-channel" data-drum="snare">
                    <div class="channel-header">
                        <span class="channel-name">SNARE</span>
                        <input type="range" class="drum-volume" min="0" max="100" value="80" data-channel="snare">
                        <span class="volume-value">80</span>
                    </div>
                    <div class="step-grid">
                        <!-- 16 steps will be created dynamically -->
                    </div>
                </div>

                <div class="drum-channel" data-drum="hihat">
                    <div class="channel-header">
                        <span class="channel-name">HI-HAT</span>
                        <input type="range" class="drum-volume" min="0" max="100" value="60" data-channel="hihat">
                        <span class="volume-value">60</span>
                    </div>
                    <div class="step-grid">
                        <!-- 16 steps will be created dynamically -->
                    </div>
                </div>

                <div class="drum-channel" data-drum="openhat">
                    <div class="channel-header">
                        <span class="channel-name">OPEN HAT</span>
                        <input type="range" class="drum-volume" min="0" max="100" value="50" data-channel="openhat">
                        <span class="volume-value">50</span>
                    </div>
                    <div class="step-grid">
                        <!-- 16 steps will be created dynamically -->
                    </div>
                </div>

                <div class="master-controls">
                    <label>
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                        </svg>
                        MASTER DRUM VOLUME
                    </label>
                    <input type="range" id="drumMasterVolume" min="0" max="100" value="100">
                    <span class="value" id="drumMasterValue">100%</span>
                </div>
            </div>
        </div>

        <!-- UI Controls -->
        <div id="controls">
            <div class="control-panel">
                <div class="brand">
                    <h1>MESMER</h1>
                    <p class="tagline">Generative Audiovisual Engine</p>
                </div>

                <div class="control-group">
                    <h3>Audio</h3>
                    <button id="playBtn" class="btn-primary">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <span>Play</span>
                    </button>
                    <div class="slider-group">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                            </svg>
                            Synth Volume
                        </label>
                        <input type="range" id="synthVolumeSlider" min="0" max="100" value="70">
                        <span class="value">70%</span>
                    </div>
                    <div class="slider-group">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h2v2H7zm8 0h2v2h-2zm-4 0h2v2h-2z"/>
                            </svg>
                            Drum Volume
                        </label>
                        <input type="range" id="drumVolumeSlider" min="0" max="100" value="70">
                        <span class="value">70%</span>
                    </div>
                    <div class="slider-group">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
                            </svg>
                            Reverb
                        </label>
                        <input type="range" id="reverbSlider" min="0" max="100" value="30">
                        <span class="value">30%</span>
                    </div>
                    <div class="slider-group">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 1v8l6-6-6-2zm0 10v10l10-10H12zM2 12h10L2 22V12z"/>
                            </svg>
                            Delay
                        </label>
                        <input type="range" id="delaySlider" min="0" max="100" value="20">
                        <span class="value">20%</span>
                    </div>
                    <div class="slider-group">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 3v15h3V3H9zm-4 2v11h3V5H5zm8 5v6h3v-6h-3zm4-3v9h3V7h-3z"/>
                            </svg>
                            BPM
                        </label>
                        <input type="range" id="bpmSlider" min="40" max="180" value="80">
                        <span class="value">80</span>
                    </div>
                    <div class="shader-selector">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                            </svg>
                            Music Genre
                        </label>
                        <select id="genreSelect">
                            <option value="ambient">Ambient</option>
                            <option value="techno">Techno</option>
                            <option value="jazz">Jazz</option>
                            <option value="drone">Drone</option>
                        </select>
                    </div>
                    <div class="shader-selector">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l-5.5 9h11L12 2zm0 3.84L13.93 9h-3.87L12 5.84zM17.5 13c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5zm0 7c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5zM3 21.5h8v-8H3v8zm2-6h4v4H5v-4z"/>
                            </svg>
                            Musical Scale
                        </label>
                        <select id="scaleSelect">
                            <option value="minor" selected>Minor (Natural)</option>
                            <option value="major">Major</option>
                            <option value="pentatonic">Pentatonic</option>
                            <option value="dorian">Dorian</option>
                            <option value="phrygian">Phrygian</option>
                        </select>
                    </div>
                    <div class="toggle-group">
                        <label class="toggle">
                            <input type="checkbox" id="drumsToggle">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 5px;">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h2v2H7zm8 0h2v2h-2zm-4 0h2v2h-2z"/>
                                </svg>
                                Drum Machine
                            </span>
                        </label>
                        <button id="openSequencerBtn" class="btn-secondary" style="margin-top: 10px; width: 100%;">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 5v14h18V5H3zm4 12H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V7h2v2zm4 8H9v-2h2v2zm0-4H9v-2h2v2zm0-4H9V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
                            </svg>
                            Pattern Editor
                        </button>
                    </div>
                    <div class="shader-selector">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/>
                            </svg>
                            Drum Machine
                        </label>
                        <select id="drumMachineSelect">
                            <!-- Dynamically populated -->
                        </select>
                    </div>
                    <div class="shader-selector">
                        <label>
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                            </svg>
                            Drum Pattern
                        </label>
                        <select id="drumPatternSelect">
                            <!-- Dynamically populated -->
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Visuals</h3>
                    <div class="toggle-group">
                        <label class="toggle">
                            <input type="checkbox" id="mainToggle" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Main Layer</span>
                        </label>
                        <label class="toggle">
                            <input type="checkbox" id="toyToggle" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">ShaderToy Layer</span>
                        </label>
                    </div>
                    <div class="shader-selector">
                        <label>Main Shader</label>
                        <select id="mainShaderSelect">
                            <optgroup label="Original">
                                <option value="0">Organic Raymarcher</option>
                                <option value="1">Fractal Tunnel</option>
                                <option value="2">Plasma Field</option>
                            </optgroup>
                            <optgroup label="Presets">
                                <option value="3">Voronoi Cells</option>
                                <option value="4">Mandelbrot Zoom</option>
                                <option value="5">Liquid Metal</option>
                                <option value="6">DNA Helix</option>
                                <option value="7">Grid Waves</option>
                            </optgroup>
                            <optgroup label="OSMOS Style">
                                <option value="8">‚ú® Glowing Orbs</option>
                                <option value="9">‚ú® Ethereal Flow</option>
                                <option value="10">‚ú® Cosmic Dust</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="shader-selector">
                        <label>Toy Shader</label>
                        <select id="toyShaderSelect">
                            <optgroup label="Original">
                                <option value="0">Audio Waves</option>
                                <option value="1">Particle Storm</option>
                                <option value="2">Kaleidoscope</option>
                            </optgroup>
                            <optgroup label="Presets">
                                <option value="3">Neon Rings</option>
                                <option value="4">Spiral Galaxy</option>
                                <option value="5">Glitch Art</option>
                                <option value="6">Hex Grid</option>
                                <option value="7">Sound Bars</option>
                            </optgroup>
                            <optgroup label="OSMOS Style">
                                <option value="8">‚ú® Ambient Motes</option>
                                <option value="9">‚ú® Aurora Waves</option>
                                <option value="10">‚ú® Dreamy Bokeh</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h3>System</h3>
                    <button id="fullscreenBtn" class="btn-secondary">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                        </svg>
                        Fullscreen
                    </button>
                    <div class="fps-meter">
                        <span>FPS: <span id="fpsValue">60</span></span>
                    </div>
                </div>
            </div>

            <!-- Audio Visualizer -->
            <div class="audio-viz">
                <canvas id="waveformCanvas"></canvas>
                <div class="freq-bars">
                    <div class="bar" id="barLow">
                        <div class="bar-fill"></div>
                        <span>LOW</span>
                    </div>
                    <div class="bar" id="barMid">
                        <div class="bar-fill"></div>
                        <span>MID</span>
                    </div>
                    <div class="bar" id="barHigh">
                        <div class="bar-fill"></div>
                        <span>HIGH</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Logger (must load first) -->
    <script src="src/debug.js"></script>

    <!-- Core Libraries - Local Tone.js with CDN fallback -->
    <script src="lib/tone.js"></script>
    <script>
        // Fallback to CDN if local Tone.js failed to load
        if (typeof Tone === 'undefined') {
            console.warn('‚ö†Ô∏è Local Tone.js failed, loading from CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js';
            script.onerror = function() {
                console.error('‚ùå CDN Tone.js also failed to load!');
            };
            document.head.appendChild(script);
        } else {
            console.log('‚úÖ Tone.js loaded locally');
        }
    </script>

    <!-- Custom Modules -->
    <script src="lib/shadertoy-lite.js"></script>
    <script src="src/visuals/osmos-shaders.js"></script>
    <script src="src/visuals/tron-shaders.js"></script>
    <script src="src/visuals/shadertoy-imports.js"></script>
    <script src="src/visuals/shader-presets.js"></script>
    <script src="src/visuals/main-shader.js"></script>
    <script src="src/visuals/toy-renderer.js"></script>
    <script src="src/audio/audio-engine.js"></script>
    <script src="src/audio/generative-music.js"></script>
    <script src="src/visuals/shader-editor.js"></script>
    <script src="app.js"></script>

    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            if (window.DEBUG) {
                DEBUG.error('JS Error: ' + e.message);
            }
            console.error('Global error:', e);
        });

        // Unhandled promise rejection
        window.addEventListener('unhandledrejection', function(e) {
            if (window.DEBUG) {
                DEBUG.error('Promise Error: ' + e.reason);
            }
            console.error('Unhandled rejection:', e);
        });
    </script>
</body>
</html>
